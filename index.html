<!doctype html>
<html>
	<head>
		<meta charset='utf-8' />
		<!--  import google icon font -->
		<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
		<!-- materialize css -->
		<link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/css/materialize.min.css"  media="screen,projection"/>
		<!-- for mobile -->
		<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
		<title>Survey</title>
		<style>
		#div-loading {
			display:none;
		}
		#div-question {
			display: none;
		}
		#further-info-card,#further-info-form {
			display: none;
		}
		#thankyou-div {
			display: none;
		}
		</style>
	</head>
	<body class='container'>
		<h2>Survey</h2>
		<p>
		Welcome to 9v's Survey website. <br />
		歡迎大家來到 9v 的實驗問卷. <br />
		</p>
		<div class="row">
			<!-- xxx: DESCRIPTION AND PURPOSE -->
			<div class="col s12" id="description-and-purpose-card">
				<div class="card blue-grey darken-1">
					<div class="card-content white-text">
						<span class="card-title">About 關於此實驗問卷</span>
						<p>
						此份問卷是有關 9v 正在進行的機械手臂與情緒表達相關研究。<br />
						因本問卷語言設定為中文，大多敘述皆以中文呈現，若您有語言理解上的困難或是特殊需求，請洽 <code>chengjovy83@gmail.com</code><br />
						<br />
						本問卷一共有六題，每一題皆為「觀看影片後作答單一選擇題」。<br />
						六部影片為快樂 (Happy)、難過 (Sad)、害怕 (Fear)、生氣 (Anger)、驚奇 (Surprise)、厭惡 (Disgust) 之機械手臂動作。<br />
						<br />
						請將影片對應到你覺得最適合的情緒選項並送出。<br />
						切記：<br />
						&nbsp;-&nbsp;影片出現順序為隨機。<br/ >
						&nbsp;-&nbsp;情緒與影片的對應為一對一，無多餘亦無重複。<br />
						&nbsp;-&nbsp;每題作答後，所選的情緒將不再出現在未來的題目選項中。<br />
						</p>
					</div>
					<!--
					<div class="card-action">
						<a href="#">This is a link</a>
						<a href="#">This is a link</a>
					</div>
					-->
				</div>
			</div>
			<!-- xxx: BASIC INFORMATION -->
			<div class="col s12" id="basic-info-card">
				<div class="card blue lighten-5">
					<div class="card-content brown-text text-darken-4">
						<span class="card-title">Basic Info 基本資料</span>
						<p>
						基於實驗數據分析，需要蒐集您的「年齡、性別、專業背景」三樣基本資料。<br />
						您的資料將會是匿名儲存於資料庫中僅供學術用途，並且不會在未經過事先請求許可的情況下與任何個人、團體分享或是公開。<br />
						選擇您的出生年、性別並填入您的專業背景後，即可開始作答。<br />
						<br />
						注：若為在學學生且有特定專業系所，請填入系所名稱。若非學生請填入職業名稱或類別。尚未就讀大專院校以上之普通科學生請填入目前教育程度即可。（舉例 (1) 電機工程學系、(2) 小說作家、(3) 國中生）<br />
						</p>
					</div>
					<!-- <div class="card-action">
						<a href="#">Happy</a>
						<a href="#">Sad</a>
						<a href="#">Fear</a>
						<a href="#">Anger</a>
						<a href="#">Surprise</a>
						<a href="#">Disgust</a>
					</div> -->
				</div>
			</div>
			<div class="col s12">
				<form id="basic-info-form">
					<div class="input-field col s12 m4">
						<select name="birthYear" id="birth-year-selector" class="browser-default">
							<option value="" disabled selected>選擇出生年</option>
						</select>
						<!--<label>Your birth year</label>-->
					</div>
					<div class="input-field col s12 m4">
						<select name="sex" class="browser-default">
							<option value="" disabled selected>選擇性別</option>
							<option value="1">Male 男性</option>
							<option value="2">Female 女性</option>
							<option value="3">Do not wish to disclose 保密</option>
						</select>
						<!--<label>Your Sex</label>-->
					</div>
					<div class="input-field col s12 m4">
						<input id="text-input-major" type="text" name="major">
						<label for="text-input-major">您的專業背景</label>
					</div>
					<!--
					<div class="input-field col s12 m4">
						<select id='major-selector' name="major" class="browser-default">
							<option value="" disabled selected>選擇專業背景</option>
						</select>
						<label>Your Major</label>
					</div>
					-->
					<div class="input-field col s12 m4">
						<a class="waves-effect waves-light btn" onclick="submitBasicInfoForm();"><i class="material-icons right">arrow_forward</i>Go 開始作答</a>
					</div>
				</form>
			</div>
			<div class="center" id="div-loading">
				<div class="preloader-wrapper big active">
					<div class="spinner-layer spinner-blue-only">
						<div class="circle-clipper left">
							<div class="circle"></div>
						</div>
						<div class="gap-patch">
							<div class="circle"></div>
						</div>
						<div class="circle-clipper right">
							<div class="circle"></div>
						</div>
					</div>
				</div>
			</div>
			<!-- xxx: Q1 -->
			<div class="col s12" id="div-question">
				<div class="card teal lighten-5">
					<div class="card-content brown-text text-darken-4">
						<span class="card-title" id="question-number">Q1</span>
						<p id="question-description">
						請觀賞下方影片後，在下列選項中選出你覺得最適合的情緒。<br />
						影片可重複觀看，次數不限。<br />
						</p>
						<p>&nbsp;</p>
						<div class="" id="question-video">
						</div>
						<p>&nbsp;</p>
						<form id='question-form'>
							<div id="question-form-options">
							</div>
							<p>&nbsp;</p>
							<a class="waves-effect waves-light btn" onclick="submitQuestionForm();"><i class="material-icons right">arrow_forward</i>Submit 送出</a>
						</form>
					</div>
				</div>
			</div>
			<!-- Further Contact Info -->
			<div class="col s12" id="further-info-card">
				<div class="card blue lighten-5">
					<div class="card-content brown-text text-darken-4">
						<span class="card-title">Further 更多</span>
						<p>
						恭喜你，已經完成了所有問卷題目，9v 在此慎重的感謝你的付出。<br />
						<br />
						若您有興趣的話可以留下您的聯絡方式，我們將會視需求安排進一步訪談以了解您問卷中的回答以及其他想法。<br />
						<br />
						謝謝你的耐心，也特別感激你犧牲寶貴時間來完成這份問卷。<br />
						</p>
						<p>&nbsp;</p>
					</div>
				</div>
			</div>
			<form id="further-info-form">
				<div class="input-field col s12 m6">
					<input id="text-input-name" name="name" type="text">
					<label for="text-input-name">Your name 您的稱呼</label>
				</div>
				<div class="input-field col s12 m6">
					<input id="text-input-email" name="email" type="email" class="validate">
					<label for="text-input-email">Your email 電子郵件</label>
					<span class="helper-text" data-error="invalid email address" data-success="valid"></span>
				</div>
				<div class="input-field col s12">
					<a class="waves-effect waves-light btn" onclick="submitFurtherInfoForm();"><i class="material-icons right">arrow_forward</i>Submit 送出</a>
				</div>
				<div class="input-field col s12">
					<a class="waves-effect waves-light btn" onclick="skipFurtherInfoForm();"><i class="material-icons right">close</i>Skip 略過並結束</a>
				</div>
			</form>
		</div>
		<div id="thankyou-div">
			<iframe src="https://giphy.com/embed/3oEdva9BUHPIs2SkGk" width="480" height="480" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/3oEdva9BUHPIs2SkGk">via GIPHY</a></p>
		</div>
		<!-- javascript -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-beta/js/materialize.min.js"></script>
		<script src="assets/js/college_major.js"></script>
		<script src="assets/js/ajax.js"></script>
		<script>
		
		// globals
		var API_SERVER_ENDPOINT = "https://www.stevenlin.tw:6969/api";
		var VIDEO_PREFIX = "https://9v.stevenlin.tw/survey/assets/videos/clipped/";
		var VIDEO_SUFFIX = ".mp4";

		var CURRENT_QUESTION_INDEX = null;
		var USER_ID = null

		function init() {
			// some initialization
			// 1) initialize major-selector
			/*
			var major_selector = $('#major-selector')[0];
			var groups = {};
			for(var collegeKey in major.colleges) {
				groups[collegeKey] = document.createElement('optgroup');
				groups[collegeKey].label = major.colleges[collegeKey];
				major_selector.appendChild(groups[collegeKey]);
			}
			for(var deptKey in major.departments) {
				var e = document.createElement('option');
				e.value = deptKey;
				e.innerHTML = major.departments[deptKey];
				groups[deptKey[0]].appendChild(e);
			}
			*/
			// 2) initialize birth-year-selector
			var birth_year_selector = $('#birth-year-selector')[0];
			for(var i=2018; i>= 1900; i--) {
				var optionElement = document.createElement('option');
				optionElement.value = i.toString();
				optionElement.innerHTML = i.toString();
				birth_year_selector.appendChild(optionElement);
			}
			// 2) initialize all selector
			$('select').formSelect();
			// 3) initialize form submit
			/*
			$('#basic-info-form')[0].submit(function(evt) {
				evt.preventDefault();
				console.log(this);
			});
			*/
		}
		$(document).ready(function(){init();});

		function showLoading() {
			$('#div-loading')[0].style.display = "block";
		}

		function hideLoading() {
			$('#div-loading')[0].style.display = "none";
		}

		function showBasicInfoForm() {
			$('#description-and-purpose-card')[0].style.display = "block";
			$('#basic-info-card')[0].style.display = "block";
			$('#basic-info-form')[0].style.display = "block";
		}

		function hideBasicInfoForm() {
			$('#description-and-purpose-card')[0].style.display = "none";
			$('#basic-info-card')[0].style.display = "none";
			$('#basic-info-form')[0].style.display = "none";
		}

		function showFurtherInfoForm() {
			$('#further-info-card')[0].style.display = "block";
			$('#further-info-form')[0].style.display = "block";
		}
		
		function hideFurtherInfoForm() {
			$('#further-info-card')[0].style.display = "none";
			$('#further-info-form')[0].style.display = "none";
		}

		function showThankYou() {
			$('#thankyou-div')[0].style.display = "block";
		}

		function hideThankYou() {
			$('#thankyou-div')[0].style.display = "none";
		}

		function showQuestion(index, videoPath, options) {
			$('#question-number')[0].innerHTML = "Q" + (index + 1);
			$('#question-number')[0].innerHTML += " / 6";
			var videoHTML = ""
			videoHTML = "<video class=\"responsive-video\" controls=\"\" webkit-playsinline playsinline>";
			videoHTML += "<source src=\"" + VIDEO_PREFIX + videoPath + VIDEO_SUFFIX + "\" type=\"video/mp4\">";
			videoHTML += "Your browser does not support the video tag.";
			videoHTML += "</video>";
			$('#question-video')[0].innerHTML = videoHTML;
			$('#question-form-options')[0].innerHTML = "";
			for(var k in options) {
				var inputElement = document.createElement('input');
				var spanElement = document.createElement('span');
				inputElement.class = "with-gap";
				inputElement.name = "answer";
				inputElement.type = "radio";
				inputElement.value = k;
				spanElement.innerHTML = options[k];
				var labelElement = document.createElement('label');
				var pElement = document.createElement('p');
				labelElement.appendChild(inputElement);
				labelElement.appendChild(spanElement);
				pElement.appendChild(labelElement);
				$('#question-form-options')[0].appendChild(pElement);
			}

			$('video.responsive-video')[0].style.maxHeight = $(window).height() * 0.8 + "px";

			$('#div-question')[0].style.display = "block";
		}

		function hideQuestion() {
			$('#div-question')[0].style.display = "none";
		}

		function submitBasicInfoForm() {
			console.log("submitting basic info form...");
			var f = $('#basic-info-form')[0];
			if(f.birthYear.value === "" || f.sex.value === "" || f.major.value === "") {
				alert("資料有誤，年齡、性別、主修皆為必填。（請填入最適合的答案）");
				return;
			}
			// 1) hide
			// 2) doAJAX()
			// 3) show
			hideBasicInfoForm();
			showLoading();
			/*
			doAJAX(
				"POST",
				API_SERVER_ENDPOINT + "/register",
				JSON.stringify({
					birthYear: parseInt(f.birthYear.value),
					sex: f.sex.value,
					major: f.major.value
				}),
				function(res) {
					res = JSON.parse(res);
					console.log(res);
					CURRENT_QUESTION_INDEX = res.result.question_index;
					USER_ID = res.result.userId;
					hideLoading();
					showQuestion(res.result.question_index, res.result.question_video, res.result.question_options);
				}
			);
			*/
			$.ajax({
				contentType: "application/json",
				data: JSON.stringify({
					birthYear: parseInt(f.birthYear.value),
					sex: f.sex.value,
					majoy: f.major.value}),
				error: (xhr, status, err) => {console.log(status);},
				success: (res, status, xhr) => {
					console.log(res);
					CURRENT_QUESTION_INDEX = res.result.question_index;
					USER_ID = res.result.userId;
					hideLoading();
					showQuestion(res.result.question_index, res.result.question_video, res.result.question_options);
				},
				type: "POST",
				url: API_SERVER_ENDPOINT + "/register"
			});
		}
		function submitQuestionForm() {
			console.log("submitting question form...");
			var f = $('#question-form')[0];
			var answer = $('input[name=answer]:checked', "#question-form").val();
			if(answer == null || answer === "") {
				alert('請做出選擇後送出。');
				return;
			}
			// 1) hide question
			// 2) show preloader
			// 3) doAJAX()
			// 4) hide preloader and show: (a) another question or (b) further info form
			hideQuestion();
			showLoading();
			/*
			doAJAX(
				"POST",
				API_SERVER_ENDPOINT + "/answer",
				JSON.stringify({
					userId: USER_ID,
					question_index: CURRENT_QUESTION_INDEX,
					answer: answer
				}),
				function(res) {
					res = JSON.parse(res);
					console.log(res);
					if(res.result == null) {
						hideLoading();
						showFurtherInfoForm();
					} else {
						CURRENT_QUESTION_INDEX = res.result.question_index;
						hideLoading();
						showQuestion(res.result.question_index, res.result.question_video, res.result.question_options);
					}
				}
			);
			*/
			$.ajax({
				contentType: "application/json",
				data: JSON.stringify({
					userId: USER_ID,
					question_index: CURRENT_QUESTION_INDEX,
					answer: answer}),
				error: (xhr, status, err) => {console.log(status);},
				success: (res, status, xhr) => {
					console.log(res);
					if(res.result == null) {
						hideLoading();
						showFurtherInfoForm();
					} else {
						CURRENT_QUESTION_INDEX = res.result.question_index;
						hideLoading();
						showQuestion(res.result.question_index, res.result.question_video, res.result.question_options);
					}
				},
				type: "POST",
				url: API_SERVER_ENDPOINT + "/answer"
			});
		}
		function submitFurtherInfoForm() {
			console.log("submitting further info form...");
			var f = $('#further-info-form')[0];
			if(f.name.value === "" || f.email.value === "") {
				alert("資料有誤，稱呼、電子郵件皆為必填。以確保聯絡得到您。");
				return;
			}
			if(!f.email.classList.contains("valid")) {
				alert("電子郵件有誤，請確認。");
				return;
			}
			// doAJAX()
			// 1) hide
			// 2) show preloader
			// 3) hide preloader and show Thank you.
			hideFurtherInfoForm();
			showLoading();
			doAJAX(
				"POST",
				API_SERVER_ENDPOINT + "/further",
				JSON.stringify({
					userId: USER_ID,
					name: f.name.value,
					email: f.email.value
				}),
				function(res) {
					res = JSON.parse(res);
					console.log(res);
					hideLoading();
					showThankYou();
				}
			);
		}
		function skipFurtherInfoForm() {
			console.log("skipping further info form...");
			hideFurtherInfoForm();
			showThankYou();
		}
		</script>
	</body>
</html>
